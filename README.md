# AHC051

## 考察

### 20250802

- 処理装置の入力の各ごみの確率の和は 1 になる
- ランダムだと各処理装置の一致するごみの確率は 1/N 程度
- 分別器の出力の評価は、あるごみの確率 p とその他のごみの確率の和 q を考えると、 p-q が大きい処理装置に割り振るのがよい
- あるベルトコンベアの辺 (v, u) を考え、交差しない点 t を考える。t から分離する経路において、上記の p-q の変化で改善する経路を追加する山登りが考えられる
- 処理装置、分別器を Node とする。Node の構造は？
  - parent: 入力のNode。複数ある
  - child1: 出力のNode。配列で2つ
  - in(M×N): 現在の親ごとの入力。ごみごとの確率。親の out に依存。子に伝播
  - processor_prob(N×N): 1 の入力に対して最終的に各処理装置に行く確率。子に依存。親に伝播
  - update_in: in が変わったときに呼ばれる
  - update_prob: 子 or 子の update_prob が変わったときに呼ばれる
  - connect: 子を紐づける。対象の子が None の時のみ。自身と親の pとate_prob, 子の update_in が必要
  - disconnect: 子を切断する。 自身と親の update_prob, 子の update_in が必要
    - update_prob, update_in は結局同時にやる？最後にまとめてやっても OK だと思う
- 上記の構造だと、childを変えるとその先すべての in, processor_prob を更新する必要がある(O(N+M))。おそらく再帰的に解ける
- out1, 2 と child の processor_prob で、割り振り先の評価ができそう
- log だと足し算
- 頂点 1 つにつき子が 2 つなので辺の最大は O(N+M) のはず。つまり交点のチェックは追加済みの辺だけチェックすれば O(N+M)
- ノードのつけかえで、すでに他に接続済みの分別器なら接続して更新するだけ、他に未接続の場合は接続済みのよさそうなものをつける？

### ChatGPT

- 機械⇔場所の割当（初期解生成）
  - ハンガリアン法によるマッチング
    - 各処理装置⇔設置候補点間の直線距離をコストとみなし，最小和マッチングを行う
    - ベルト長の総和を抑えられる初期配置になる
  - 局所交換ヒューリスティック（2-opt, 3-opt）
    - 上記初期割当に対して，２つの装置を入れ替えて改善できるなら交換
    - 繰り返して局所最適を目指す
- 分別器の配置・選択戦略
  - 貪欲選択＋情報利得
    - 各分別器スペースに「何種のゴミをどれだけ purity（純度）高く分けられるか」を評価指標として計算
    - 情報利得（entropy減少量）が大きい分別器から優先的に配置
  - 再帰的パーティショニング（決定木ライク）
    - 現状の未分別ゴミ集合を，ある分別器で二分したときに「処理装置位置の集合」が平面上でなるべく分離・連続するような分割を探す
    - 分割対象の処理装置群が空間的に近いもの同士でまとまるように，K-means や BSP（Binary Space Partitioning）を併用
- ベルトコンベアの敷設（平面グラフ・プランニング）
  - 再帰的ツリー埋め込み
    - 上記再帰的パーティショニングで得た二分木構造（決定木）をそのまま平面に描画
    - ルート（入口）から子ノード（分別器 or 装置）へ枝を伸ばす際，扇形区間を割り当てて枝同士の交差を回避
  - 最小全域木（MST）ベース
    - 全頂点（入口＋分別器＋処理装置）間のMSTをまず構築
    - そこから枝を重みづけし，確率的分岐に応じて枝を２分岐構造に振り直す
  - スイープライン or 回転カリキュラム
    - 入口を中心に角度ソートし，角度順に伸びる「放射状」レイアウト
    - 途中で分岐が必要なときは，その枝が覆う角度扇を子分岐に割り振る
- メタヒューリスティックによる改善
  - シミュレーテッド・アニーリング
    - 現解：配置＋割当＋ベルト経路
    - 乱択で「分別器の場所を一つ交換」「２本のベルト経路を入れ替え」「装置割当をswap」など
    - 受入判定に温度パラメータを用いて大域探索
  - 遺伝的アルゴリズム
    - 個体：分別器の選択・配置と装置割当の全情報を染色体化
    - 交叉／突然変異で多様な解を生成し，高評価解を繁殖
  - 局所探索＋タブーサーチ
    - 簡単な局所交換（swap, re-route）を繰り返し，改善しなくなったらタブーリストで行動を制限
- 実装上のポイントと注意
  - 平面非交差制約：再帰的レイアウトか角度ソートによる厳格管理を入れる
  - 非閉路制約：グラフ構築時に常にトポロジカルソート可能かチェック
  - 時間制限内の高速化：
    - 初期解は貪欲＋MSTなど低コストで
    - 改善ステップは局所的な変更のみで距離計算を再利用
  - 評価関数：期待正答率（各ゴミが正しい処理装置へ行く確率の総和）やベルト総延長など，重み付けで合成

## history

- v0: 

## command

- 1テストケース実行

```
cargo build
cat .\in\0000.txt | .\target\debug\ahc051.exe > .\out\0000.txt
```

- 一括実行

```
cargo build
python .\simulator.py
```

- tester実行

```
cargo build --release
cat .\in\0000.txt | .\tester.exe .\target\release\ahc051.exe > out.txt
```
